{% extends 'base.html' %}

{% block title %}
    {{ article.headline }}
{% endblock %}

{% block style %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/full_article_view.css' %}"> 
{% endblock %}

{% block content %}
<header id="header">
    <div id="date-container">
        <button>
            <div></div>
            <div></div>
            <div></div>
        </button>
        <p>{{current_date}}</p>
    </div>
    
    <div id="header-logo"><img src="{% static '\icons\full-logo.svg' %}" alt="">
    </div>
    <form method="GET" action="{% url 'search' %}">
        {% csrf_token %}
        <div>
            <img src="{% static '\icons\search.svg' %}" alt="">
        </div>
        <input 
            type="text" 
            name="query" 
            placeholder="Search headlines" 
            required
        >
    </form>
</header>





{% include 'article-template.html' %}

{% include 'related-story-comments.html' %}





{% include 'footer.html' %}





{% block scripts %}
    {% load static %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>



        function likeComment(commentId) {
            $.ajax({
                url: "{% url 'like_comment' %}", // Replace with the URL of your like view
                type: "POST",
                data: {
                comment_id: commentId,
                csrfmiddlewaretoken: "{{ csrf_token }}", // Include CSRF token for security
                },
                success: function (data) {
                // Update the like count in the UI
                    refreshInteractionCount(commentId,data.likes,data.dislikes);
                    // Get the like icon and data attributes for the URLs
                    refreshIconStates(commentId,data.user_liked,data.user_disliked);
                    
                },
                error: function (xhr, textStatus, errorThrown) {
                console.error("Error liking comment:", errorThrown);
                },
            });
        }

        function dislikeComment(commentId) {
            $.ajax({
                url: "{% url 'dislike_comment' %}", // Replace with the URL of your dislike view
                type: "POST",
                data: {
                comment_id: commentId,
                csrfmiddlewaretoken: "{{ csrf_token }}",
                },
                success: function (data) {
                // Update the dislike count in the UI
                    refreshInteractionCount(commentId,data.likes,data.dislikes);
                    refreshIconStates(commentId,data.user_liked,data.user_disliked);
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.error("Error disliking comment:", errorThrown);
                },
            });
        }


        function refreshInteractionCount(commentId,likes,dislikes){
            const likeCountElement = document.getElementById(`like-count-${commentId}`);
            const dislikeCountElement = document.getElementById(`dislike-count-${commentId}`);
                    
                    // Update the like and dislike counts based on the response
            if (likeCountElement) likeCountElement.textContent = likes;
            if (dislikeCountElement) dislikeCountElement.textContent = dislikes;
        }

        function refreshIconStates(commentId,user_liked,user_disliked){
            // like
            const likeIcon = document.querySelector(`#like-icon-${commentId}`);
            const likeUrl = likeIcon.getAttribute('data-like-url');
            const likeBoldUrl = likeIcon.getAttribute('data-like-bold-url');
            console.log(likeUrl,likeBoldUrl);

            // Update the icon src based on whether the user liked it
            likeIcon.src = (user_liked ? likeBoldUrl : likeUrl);
            console.log( likeIcon.src);

            // dislike
            const dislikeIcon = document.querySelector(`#dislike-icon-${commentId}`);
            const dislikeUrl = dislikeIcon.getAttribute('data-dislike-url');
            const dislikeBoldUrl = dislikeIcon.getAttribute('data-dislike-bold-url');
            console.log(dislikeUrl,dislikeBoldUrl);

            // Update the icon src based on whether the user liked it
            dislikeIcon.src = (user_disliked ? dislikeBoldUrl : dislikeUrl);
            console.log( dislikeIcon.src);

        }


        function addComment() {
            // Collect data from the comment form
            const commentContent = $('#comment-content').val();  // Get the value from the textarea
            const articleId = '{{ article.id }}'; // Replace with the correct method to get the article ID
            console.log(commentContent,articleId);

            // Send AJAX request to add the comment
            $.ajax({
                url: "{% url 'add_comment' article.id %}",  // Update this with your actual URL for adding comments
                type: "POST",  // Assuming you're using POST to add comments
                data: {
                    'content': commentContent,
                    'article_id': articleId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'  // Include CSRF token for security
                },
                success: function(data) {
                    // Clear the comment input field
                    $('#comment-content').val('');
                    $('#sort-comments').val('newest').change()

                    // Update the comments section with the new comment
                    $('#comments-container').html(data.comments_html);  // Update the comments section with the new HTML

                    const commentCount = data.comment_count || 0; // Get new comment count from the response
                    $('#comment-section-heading p').text(`${commentCount} comment${commentCount !== 1 ? 's' : ''}`);
        
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.error("Error adding comment:", errorThrown);
                }
            });
        }



        function sortComments(sortBy) {
            console.log(sortBy);
            $.ajax({
                url: "{% url 'sort_comments' article.id %}",  // Update this with your actual URL
                data: {
                    'sort_by': sortBy
                },
                success: function(data) {
                    $('#comments-container').html(data.comments_html);  // Update the comments section
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.error("Error fetching sorted comments:", errorThrown);
                }
            });
        }

        function deleteComment(comment_id) {
            $.ajax({
                url: "{% url 'delete_comment' '0' %}".replace('0', comment_id),  // Use a placeholder and replace it with comment_id
                type: "DELETE",
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token in the header
                },
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data) {
                    $('#comments-container').html(data.comments_html);
                    $('#comment-section-heading p').text(data.comment_count + ' comment' + (data.comment_count === 1 ? '' : 's'));
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.error("Error deleting comment:", errorThrown);
                }
            });
        }

        function promptUserToLogin(button) {
    // Remove any existing popup to prevent duplicates
    removePopup();

    // Fetch the template from the included HTML
    const template = document.getElementById("login-popup-template");
    if (!template) {
        console.error("Popup template not found!");
        return;
    }

    const popup = template.cloneNode(true);
    popup.id = "login-popup"; // Assign a new ID to the clone
    popup.style.display = "block"; // Make the cloned popup visible

    // Position the popup relative to the button
    const rect = button.getBoundingClientRect();
    popup.style.position = "absolute";
    popup.style.top = `${rect.bottom + window.scrollY + 5}px`; // Adjust for spacing
    popup.style.left = `${rect.left + window.scrollX}px`;
    popup.style.zIndex = "1000";

    // Append the popup to the body
    document.body.appendChild(popup);

    // Add event listeners for the buttons
    // popup.querySelector("#login-btn").onclick = () => {
    //     window.location.href = "/login/";
    // };
    // popup.querySelector("#signup-btn").onclick = () => {
    //     window.location.href = "/signup/";
    // };

    // Add mouseover and mouseout events to handle visibility
    popup.addEventListener("mouseover", () => {
        popup.dataset.keep = "true";
    });
    popup.addEventListener("mouseout", () => {
        popup.dataset.keep = "false";
        setTimeout(() => removePopup(), 200); // Delay for smoothness
    });
}

function removePopup() {
    const popup = document.getElementById("login-popup");
    if (popup && popup.dataset.keep !== "true") popup.remove();
}

        

    </script>

    
{% endblock %}

{% endblock %}
