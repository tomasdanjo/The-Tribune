{% extends 'base.html' %}
{% load static %}

{% block title %}
    {{ request.user.userprofile.first_name}} {{ request.user.userprofile.last_name }}
{% endblock %}

{% block style %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    
    <link rel="stylesheet" href="{% static 'css/category_view.css' %}"> 
    <link rel="stylesheet" href="{% static 'css/writer-editor.css' %}"> 
{% endblock %}

{% block content %}

{% include 'header.html' %}

<div id="main">

    <nav>
        <button onclick="showSection('published-section')">
        <img src="{% static 'icons/published.svg' %}" alt="">
            <p>Published</p></button>
        <button onclick="showSection('draft-section')" >
           <img src="{% static 'icons/draft.svg' %}" alt=""> <p>Draft</p></button>
        <button onclick="showSection('submitted-section')" ><img src="{% static 'icons/submit.svg' %}" alt=""><p>Submitted</p></button>
        <button onclick="showSection('archived-section')" ><img src="{% static 'icons/archive.svg' %}" alt=""><p>Archived</p></button>
        <button onclick="showSection('notification-section')" ><img src="{% static 'icons/notif.svg' %}" alt=""><p>Notification</p></button>
        <a id="write-article-btn" href="{% url 'create_article' %}"><img src="{% static 'icons/write.svg' %}" alt=""><p>Write Article</p></a>  
    </nav>
        

    <div id="content">
        <div id="published-section" class="article-section">
            <h2>Published Articles</h2>
            <div class="article-card-container">
                <div class="articles-container">
                    {{ published }}
                </div>
            </div>
        </div>
        
        <div id="draft-section" class="article-section">
            <h2>Drafted Articles</h2>
            <div class="article-card-container">
                <div class="article-card-grid">
                    {{ drafts }}
                </div>
            </div>
        </div>

        <div id="submitted-section" class="article-section">
            <h2>Submitted Articles</h2>
            <div class="article-card-container">
                <div class="article-card-grid">
                    {{ submitted }}
                </div>
            </div>
        </div>

        <div id="archived-section" class="article-section">
            <h2>Archived Articles</h2>
            <div class="article-card-container">
                <div class="article-card-grid">
                    {{ archived }}
                </div>
            </div>
        </div>
    


        <div id="notification-section" 
        class="notification-container" >
        
            <div class="notification-tabs submit-btn-group">
                <button class="active submit-btn" id="unread-tab" onclick="showUnreadNotifications()">
                    Unread
                </button>
                <button class="submit-btn" id="read-tab" onclick="showReadNotifications()">
                    Read
                </button>
                
                <button class="mark-all-btn submit-btn" id="mark-all-btn" onclick="markAllAsRead()">
                    <i class="fas fa-check-double"></i> Mark all as read
                </button>

                
            </div>
    
            
            <div id="unread-notif-container" class="notification-list">
                
                {% include 'notification-card.html' with notifications=unread_notifs%}
                
                
            </div>
    
            <div id="read-notif-container" class="notification-list" style="display: none;">
                {% include 'notification-card.html' with notifications=read_notifs%}
            </div>
        </div>
    
    
        
    </div>



    
</div>

<!-- JavaScript to toggle visibility -->
<script>

$(document).ready(function() {
        {% if not unread_notifs %}
            $('#mark-all-btn').hide();
        {% endif %}
    });
    
const csrf_token = '{{ csrf_token }}';
    // Function to toggle the options menu
function toggleOptionsMenu(button) {
  const menu = button.nextElementSibling;
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

// Function to mark a notification as read and refresh the notifications container
function markAsRead(notificationId) {
    fetch('/mark-as-read/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token  // Ensure CSRF token is defined in your template
        },
        body: JSON.stringify({ id: notificationId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeOptionsMenu();
            fetchUnreadNotifications(); 
            fetchReadNotifications();  // Refresh the read notifications container
        } else {
            alert('Failed to mark notification as read');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Function to mark a notification as unread and refresh the notifications container
function markAsUnread(notificationId) {
    fetch('/mark-as-unread/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token  // Ensure CSRF token is defined in your template
        },
        body: JSON.stringify({ id: notificationId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeOptionsMenu();
            fetchReadNotifications();
            fetchUnreadNotifications();  // Refresh the unread notifications container
        } else {
            alert('Failed to mark notification as unread');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}


// Function to close all options menus
function closeOptionsMenu() {
  document.querySelectorAll('.options-menu').forEach(menu => {
    menu.style.display = 'none';
  });
}

// Close the menu when clicking outside
document.addEventListener('click', function(event) {
  const optionsMenus = document.querySelectorAll('.options-menu');
  optionsMenus.forEach(menu => {
    if (!menu.contains(event.target) && !menu.previousElementSibling.contains(event.target)) {
      menu.style.display = 'none';
    }
  });
});

    

    function showReadNotifications(){
        const unreadContainer = document.getElementById('unread-notif-container');
        const readContainer = document.getElementById('read-notif-container');
        const unreadBtn = document.querySelector('#unread-tab');
        const readBtn = document.querySelector('#read-tab');
    

        unreadContainer.style.display = 'none';
        readContainer.style.display = 'block';
        readBtn.classList.add('active');
        unreadBtn.classList.remove('active');

        // Load read notifications if not already loaded
        if (readContainer.children.length <= 1) {
            fetchReadNotifications();
        }
    }

    function showUnreadNotifications(){
        const unreadContainer = document.getElementById('unread-notif-container');
        const readContainer = document.getElementById('read-notif-container');
        const unreadBtn = document.querySelector('#unread-tab');
        const readBtn = document.querySelector('#read-tab');

        unreadContainer.style.display = 'block';
        readContainer.style.display = 'none';
        unreadBtn.classList.add('active');
        readBtn.classList.remove('active');
    }

    function markAllAsRead(){
        const unreadContainer = document.getElementById('unread-notif-container');
        const readContainer = document.getElementById('read-notif-container');
        const unreadBtn = document.querySelector('#unread-tab');
        const readBtn = document.querySelector('#read-tab');
        fetch('/notifications/mark_all_read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Clear unread notifications
                const notificationLinks = unreadContainer.querySelectorAll('a');
                notificationLinks.forEach(link => link.remove());

                // Fetch and populate read notifications
                fetchUnreadNotifications()
                fetchReadNotifications();
                document.getElementById('mark-all-btn').style.display = "none";

            }
        })
        .catch(error => console.error('Error:', error));
    }

    function addNotificationLinkListeners() {
        const unreadContainer = document.getElementById('unread-notif-container');
        const readContainer = document.getElementById('read-notif-container');
        const unreadBtn = document.querySelector('#unread-tab');
        const readBtn = document.querySelector('#read-tab');
        const notificationLinks = unreadContainer.querySelectorAll('a');
        notificationLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const notificationId = this.dataset.notificationId;
                
                // Mark this specific notification as read
                fetch(`/notifications/mark_read/${notificationId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Remove from unread, add to read
                        this.remove();
                        
                        // Optionally, update read notifications
                        fetchReadNotifications();
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    }

// Function to fetch and display read notifications using jQuery AJAX
function fetchReadNotifications() {
    const readContainer = $('#read-notif-container');
    $.ajax({
        url: '/notifications/read/',
        method: 'GET',
        success: function(html) {
            if (html.trim() !== "") {
                readContainer.html(html);
            } else {
                readContainer.html('<p>No read notifications</p>');
            }
        },
        error: function() {
            console.error('Error fetching read notifications.');
        }
    });
}

// Function to fetch and display unread notifications using jQuery AJAX
function fetchUnreadNotifications() {
    const unreadContainer = $('#unread-notif-container');
    $.ajax({
        url: '/notifications/unread/',
        method: 'GET',
        success: function(html) {
            if (html.trim() !== "") {
                unreadContainer.html(html);
                $('#mark-all-btn').show();
            } else {
                unreadContainer.html('<p>No unread notifications</p>');
                $('#mark-all-btn').hide();
            }
        },
        error: function() {
            console.error('Error fetching unread notifications.');
        }
    });
}

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    document.addEventListener('DOMContentLoaded', function() {
        addNotificationLinkListeners();
    });

    function toggleDropdown() {
        var dropdown = document.getElementById("profile-dropdown");
        dropdown.classList.toggle("hidden");
    }
</script>

<script>
    function logoutUser() {
        const csrfToken = '{{ csrf_token }}';  // Get the CSRF token from the template context
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'logout' %}";  // The logout URL
    
        // Create a hidden CSRF token field
        const csrfField = document.createElement('input');
        csrfField.type = 'hidden';
        csrfField.name = 'csrfmiddlewaretoken';
        csrfField.value = csrfToken;
    
        // Append the CSRF token field to the form
        form.appendChild(csrfField);
    
        // Append the form to the body (it won't be visible to the user)
        document.body.appendChild(form);
    
        // Submit the form
        form.submit();
    }
</script>

<script>
    // Function to show the selected section and hide the others
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.article-section').forEach(section => {
            section.classList.add('hidden');
        });

        // Show the selected section
        document.getElementById(sectionId).classList.remove('hidden');
        
        // Remove 'selected' class from all buttons
    document.querySelectorAll('nav button').forEach(button => {
        button.classList.remove('selected');
    });

    // Add 'selected' class to the clicked button
    const clickedButton = [...document.querySelectorAll('nav button')].find(button => 
        button.onclick.toString().includes(sectionId)
    );
    if (clickedButton) clickedButton.classList.add('selected');


    }

    // Initially, show the 'published' section
    document.addEventListener('DOMContentLoaded', function() {
        showSection('published-section');
    });
</script>

<style>
    .hidden {
        display: none;
    }
</style>
{% endblock %}